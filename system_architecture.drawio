<mxfile host="Electron" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/29.0.3 Chrome/140.0.7339.249 Electron/38.7.0 Safari/537.36" version="29.0.3">
  <diagram id="ammonia-outlet-system" name="System Architecture">
    <mxGraphModel dx="1732" dy="1084" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="1200" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="title" value="AMMONIA DEMONSTRATOR OUTLET - SYSTEM ARCHITECTURE" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=24;fontStyle=1;fontColor=#333333;" parent="1" vertex="1">
          <mxGeometry x="400" y="20" width="800" height="40" as="geometry" />
        </mxCell>
        <mxCell id="mqtt_broker" value="MQTT Broker&#xa;(ammonia-master.local:1883)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=14;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="660" y="80" width="280" height="60" as="geometry" />
        </mxCell>
        <mxCell id="outlet_pi_container" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;strokeWidth=2;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="40" y="180" width="1520" height="900" as="geometry" />
        </mxCell>
        <mxCell id="outlet_pi_label" value="Raspberry Pi (OutletPi)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=16;fontStyle=1;fontColor=#333333;" parent="1" vertex="1">
          <mxGeometry x="130" y="200" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="manager_outlet" value="manager_outlet.py&#xa;(systemd service)&#xa;&#xa;• Listens: master/outlet/control&#xa;• Spawns/kills main_module.py&#xa;• Publishes: slave/outlet/status" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;align=left;spacingLeft=10;" parent="1" vertex="1">
          <mxGeometry x="60" y="240" width="220" height="120" as="geometry" />
        </mxCell>
        <mxCell id="main_module" value="main_module.py&#xa;(Main Entry Point)&#xa;&#xa;• Task Scheduler (6 tasks)&#xa;• 10ms loop tick&#xa;• Exception handling per task" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;fontStyle=1;align=left;spacingLeft=10;" parent="1" vertex="1">
          <mxGeometry x="320" y="240" width="200" height="120" as="geometry" />
        </mxCell>
        <mxCell id="common_config" value="common_config.py&#xa;(Shared Infrastructure)&#xa;&#xa;• MQTT client creation&#xa;• Modbus device factory&#xa;• RS485 buffer clearing&#xa;• Thread lock (serial_lock)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=12;align=left;spacingLeft=10;" parent="1" vertex="1">
          <mxGeometry x="560" y="240" width="200" height="120" as="geometry" />
        </mxCell>
        <mxCell id="mqtt_pub_box" value="MQTT Topics Published&#xa;─────────────────&#xa;slave/outlet/temperature&#xa;slave/outlet/humidity&#xa;slave/outlet/flowrate&#xa;slave/bypass/ammonia_ppm_1&#xa;slave/bypass/ammonia_ppm_2&#xa;slave/outlet/status" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;align=left;spacingLeft=10;" parent="1" vertex="1">
          <mxGeometry x="800" y="220" width="200" height="150" as="geometry" />
        </mxCell>
        <mxCell id="mqtt_sub_box" value="MQTT Topics Subscribed&#xa;─────────────────&#xa;master/outlet/fan_out&#xa;master/bypass/relay_bypass&#xa;master/outlet/control" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;align=left;spacingLeft=10;" parent="1" vertex="1">
          <mxGeometry x="1040" y="220" width="200" height="100" as="geometry" />
        </mxCell>
        <mxCell id="task_container" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=1;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="60" y="400" width="700" height="280" as="geometry" />
        </mxCell>
        <mxCell id="task_label" value="Task Scheduler (6 Concurrent Tasks)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1;fontColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="70" y="410" width="280" height="20" as="geometry" />
        </mxCell>
        <mxCell id="task_hg803" value="Task 1: read_HG803&#xa;Interval: 3s&#xa;─────────────&#xa;• Reads temp/humidity&#xa;• Publishes to MQTT" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e6ffcc;strokeColor=#82b366;fontSize=11;align=left;spacingLeft=5;" parent="1" vertex="1">
          <mxGeometry x="80" y="440" width="140" height="100" as="geometry" />
        </mxCell>
        <mxCell id="task_trox" value="Task 2: read_TROX&#xa;Interval: 6s&#xa;─────────────&#xa;• Reads flow rate&#xa;• Publishes to MQTT" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e6ffcc;strokeColor=#82b366;fontSize=11;align=left;spacingLeft=5;" parent="1" vertex="1">
          <mxGeometry x="240" y="440" width="140" height="100" as="geometry" />
        </mxCell>
        <mxCell id="task_fan" value="Task 3: fan_control&#xa;Interval: 5s&#xa;─────────────&#xa;• Checks MQTT msg&#xa;• Sets fan speed %" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;align=left;spacingLeft=5;" parent="1" vertex="1">
          <mxGeometry x="400" y="440" width="140" height="100" as="geometry" />
        </mxCell>
        <mxCell id="task_ammo1" value="Task 4: read_ammonia#1&#xa;Interval: 5s&#xa;─────────────&#xa;• Inlet sensor (addr 37)&#xa;• Publishes to MQTT" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e6ffcc;strokeColor=#82b366;fontSize=11;align=left;spacingLeft=5;" parent="1" vertex="1">
          <mxGeometry x="80" y="560" width="140" height="100" as="geometry" />
        </mxCell>
        <mxCell id="task_ammo2" value="Task 5: read_ammonia#2&#xa;Interval: 5s&#xa;─────────────&#xa;• Outlet sensor (addr 38)&#xa;• Publishes to MQTT" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e6ffcc;strokeColor=#82b366;fontSize=11;align=left;spacingLeft=5;" parent="1" vertex="1">
          <mxGeometry x="240" y="560" width="140" height="100" as="geometry" />
        </mxCell>
        <mxCell id="task_relay" value="Task 6: relay_control&#xa;Interval: 5s&#xa;─────────────&#xa;• Checks MQTT msg&#xa;• Controls valves&#xa;• Vacuum pump logic" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;align=left;spacingLeft=5;" parent="1" vertex="1">
          <mxGeometry x="400" y="560" width="140" height="100" as="geometry" />
        </mxCell>
        <mxCell id="legend_read" value="READ (Sensor)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e6ffcc;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="570" y="470" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="legend_write" value="WRITE (Control)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="570" y="510" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="classes_container" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;strokeWidth=1;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="800" y="400" width="340" height="280" as="geometry" />
        </mxCell>
        <mxCell id="classes_label" value="Controller Classes" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1;fontColor=#666666;" parent="1" vertex="1">
          <mxGeometry x="810" y="410" width="150" height="20" as="geometry" />
        </mxCell>
        <mxCell id="fan_class" value="FanControll&#xa;(fan/fan_control.py)&#xa;────────────────&#xa;• slave_address: 4&#xa;• fan_initialization()&#xa;• fan_control()&#xa;• fan_stop()&#xa;• MQTT callback" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;align=left;spacingLeft=5;" parent="1" vertex="1">
          <mxGeometry x="820" y="440" width="150" height="120" as="geometry" />
        </mxCell>
        <mxCell id="relay_class" value="MultiRelayControl&#xa;(MultiRelay/multi_relay_control.py)&#xa;────────────────&#xa;• slave_address: 35&#xa;• relay_initialization()&#xa;• relay_control()&#xa;• motor_run() / motor_stop()&#xa;• relay_close()&#xa;• MQTT callback" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;align=left;spacingLeft=5;" parent="1" vertex="1">
          <mxGeometry x="980" y="440" width="150" height="140" as="geometry" />
        </mxCell>
        <mxCell id="rs485_interface" value="RS485 Serial Interface&#xa;(/dev/ttyACM0)&#xa;────────────────&#xa;Baudrate: 9600&#xa;Mode: Modbus RTU&#xa;Thread-safe via serial_lock" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;fontStyle=1;align=left;spacingLeft=10;" parent="1" vertex="1">
          <mxGeometry x="560" y="720" width="200" height="110" as="geometry" />
        </mxCell>
        <mxCell id="hw_container" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#333333;strokeWidth=2;" parent="1" vertex="1">
          <mxGeometry x="60" y="880" width="1200" height="180" as="geometry" />
        </mxCell>
        <mxCell id="hw_label" value="Hardware Devices (RS485 Modbus RTU Bus)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1;fontColor=#333333;" parent="1" vertex="1">
          <mxGeometry x="70" y="890" width="350" height="20" as="geometry" />
        </mxCell>
        <mxCell id="hw_hg803" value="HG803&#xa;Temp/Humidity&#xa;Sensor&#xa;────────&#xa;Addr: 3&#xa;Reg: 0x0000" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;align=center;" parent="1" vertex="1">
          <mxGeometry x="80" y="920" width="100" height="120" as="geometry" />
        </mxCell>
        <mxCell id="hw_fan" value="Fan&#xa;Controller&#xa;(AC Motor)&#xa;────────&#xa;Addr: 4&#xa;Reg: 30" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;align=center;" parent="1" vertex="1">
          <mxGeometry x="200" y="920" width="100" height="120" as="geometry" />
        </mxCell>
        <mxCell id="hw_trox" value="TROX&#xa;Flowmeter&#xa;(m³/h)&#xa;────────&#xa;Addr: 9&#xa;Reg: 7" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;align=center;" parent="1" vertex="1">
          <mxGeometry x="320" y="920" width="100" height="120" as="geometry" />
        </mxCell>
        <mxCell id="hw_relay" value="Multi-Relay&#xa;Module&#xa;────────&#xa;Addr: 35&#xa;CH0-2: Valves&#xa;CH3: Pump" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;align=center;" parent="1" vertex="1">
          <mxGeometry x="440" y="920" width="110" height="120" as="geometry" />
        </mxCell>
        <mxCell id="hw_ammo1" value="Ammonia&#xa;Sensor #1&#xa;(Inlet)&#xa;────────&#xa;Addr: 37&#xa;Reg: 4" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;align=center;" parent="1" vertex="1">
          <mxGeometry x="570" y="920" width="100" height="120" as="geometry" />
        </mxCell>
        <mxCell id="hw_ammo2" value="Ammonia&#xa;Sensor #2&#xa;(Outlet)&#xa;────────&#xa;Addr: 38&#xa;Reg: 4" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;align=center;" parent="1" vertex="1">
          <mxGeometry x="690" y="920" width="100" height="120" as="geometry" />
        </mxCell>
        <mxCell id="hw_legend_sensor" value="Sensor (Read)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="930" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="hw_legend_actuator" value="Actuator (Write)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1000" y="970" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="conn1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#6c8ebf;strokeWidth=2;endArrow=classic;endFill=1;" parent="1" source="mqtt_pub_box" target="mqtt_broker" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="conn1_label" value="Publish" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="920" y="150" width="50" height="20" as="geometry" />
        </mxCell>
        <mxCell id="conn2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#d79b00;strokeWidth=2;endArrow=classic;endFill=1;" parent="1" source="mqtt_broker" target="mqtt_sub_box" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="conn2_label" value="Subscribe" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1050" y="150" width="60" height="20" as="geometry" />
        </mxCell>
        <mxCell id="conn3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#9673a6;strokeWidth=2;endArrow=classic;endFill=1;dashed=1;" parent="1" source="manager_outlet" target="main_module" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="conn3_label" value="subprocess" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#9673a6;" parent="1" vertex="1">
          <mxGeometry x="270" y="280" width="60" height="20" as="geometry" />
        </mxCell>
        <mxCell id="conn4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#82b366;strokeWidth=2;endArrow=classic;endFill=1;" parent="1" source="main_module" target="common_config" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="conn4_label" value="imports" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="510" y="285" width="50" height="20" as="geometry" />
        </mxCell>
        <mxCell id="conn5" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#d6b656;strokeWidth=2;endArrow=classic;endFill=1;" parent="1" source="main_module" target="task_container" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="420" y="370" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="conn6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#b85450;strokeWidth=2;endArrow=classic;endFill=1;" parent="1" source="main_module" target="classes_container" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="540" y="300" />
              <mxPoint x="540" y="380" />
              <mxPoint x="780" y="380" />
              <mxPoint x="780" y="540" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="conn6_label" value="instantiates" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#b85450;" parent="1" vertex="1">
          <mxGeometry x="730" y="360" width="60" height="20" as="geometry" />
        </mxCell>
        <mxCell id="conn7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#9673a6;strokeWidth=2;endArrow=classic;endFill=1;" parent="1" source="task_container" target="rs485_interface" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="conn7_label" value="Modbus RTU" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#9673a6;" parent="1" vertex="1">
          <mxGeometry x="500" y="700" width="70" height="20" as="geometry" />
        </mxCell>
        <mxCell id="conn8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#9673a6;strokeWidth=2;endArrow=classic;endFill=1;" parent="1" source="classes_container" target="rs485_interface" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="970" y="770" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="conn9" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#333333;strokeWidth=3;endArrow=classic;endFill=1;" parent="1" source="rs485_interface" target="hw_container" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="conn9_label" value="RS485 Bus" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontStyle=1;fontColor=#333333;" parent="1" vertex="1">
          <mxGeometry x="670" y="845" width="80" height="20" as="geometry" />
        </mxCell>
        <mxCell id="modbus_info" value="Modbus Function Codes&#xa;────────────────&#xa;FC3: Read holding registers&#xa;FC4: Read input registers&#xa;FC5: Write single coil&#xa;FC6: Write single register" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=11;align=left;spacingLeft=10;" parent="1" vertex="1">
          <mxGeometry x="1180" y="720" width="180" height="110" as="geometry" />
        </mxCell>
        <mxCell id="flow_summary" value="Data Flow Summary&#xa;──────────────────────────────&#xa;1. Sensors → read_* functions → MQTT publish&#xa;2. MQTT subscribe → callback → class methods&#xa;3. Class methods → Modbus write → Actuators&#xa;4. All serial access protected by serial_lock" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;align=left;spacingLeft=10;" parent="1" vertex="1">
          <mxGeometry x="1180" y="560" width="260" height="130" as="geometry" />
        </mxCell>
        <mxCell id="utils_box" value="Utility Modules&#xa;─────────────────&#xa;calculate_CRC.py - CRC16 checksum&#xa;search_device.py - Device discovery&#xa;*_status.py - Register queries&#xa;*_test.py - Manual testing" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;fontSize=11;align=left;spacingLeft=10;" parent="1" vertex="1">
          <mxGeometry x="1280" y="240" width="200" height="110" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
